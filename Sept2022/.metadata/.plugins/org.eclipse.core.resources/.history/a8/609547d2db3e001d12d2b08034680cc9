package com.michael.serv;

import java.io.*;  
import javax.servlet.*;  
import javax.servlet.http.*; 
import java.sql.Connection;
import java.sql.DatabaseMetaData;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import com.michael.serv.DatabaseConnection;

public class CRUD extends HttpServlet{
	
	public void doPost(HttpServletRequest request, HttpServletResponse response)  
	        throws ServletException, IOException {  
		
		try {
			Connection con = DatabaseConnection.initializeDatabase();
			response.setContentType("text/html");
			PrintWriter out = response.getWriter();
			
			PreparedStatement pst = 
					con.prepareStatement("create table employees(empID varchar(10), firstName varchar(255), lastName varchar(255), primary key(empID))");
			if(tableExists(con, "employees") == false) {
				pst.execute();
			}
			
			PreparedStatement q = con.prepareStatement("select * from employees where empID = ? and firstName = ? and lastName = ?");
			q.setString(1, request.getParameter("empID"));
			q.setString(2, request.getParameter("firstName"));
			q.setString(3, request.getParameter("lastName"));
			ResultSet rs = q.executeQuery();
			if(rs.absolute(1)) {
				out.print("Employee Already Exists!");
				RequestDispatcher rd = request.getRequestDispatcher("/index.html");
				rd.include(request, response);
			}
			else {
				add(con, out, request.getParameter("empID"), request.getParameter("firstName"), request.getParameter("lastName"));
			}
			
		}catch(SQLException e) {
			
		}
	    

	    }  
	
	
	public static void add(Connection con, PrintWriter out, String empID, String firstName, String lastName) throws SQLException {
		PreparedStatement p = con.prepareStatement("insert into employees(empID, firstName, lastName) values(?, ?, ?)");
		p.setString(1, empID);
		p.setString(2, firstName);
		p.setString(3,  lastName);
		p.executeUpdate();
		System.out.println("Employee added successfully!");
	}
	
	public static boolean tableExists(Connection con, String tableName) throws SQLException{
		DatabaseMetaData meta = con.getMetaData();
		ResultSet resultSet = meta.getTables(null,  null, tableName, new String[]{"TABLE"});
		return resultSet.next();
	}
	} 
